# **Azure IoT Plug-and-Play Bridge Adapter: Impinj Reader R700**

Included in this folder are the source files for an adapter extension to the Azure IoT Plug-and-Play (PnP) Bridge which allows the Impinj R700 RFID Fixed Reader to communicate with Azure IoT cloud services. 

The latest compiled versions of this to use with Impinj R700 readers can be found here: TBD

The adapter itself communicates with the Reader Configuration REST API on the R700 and exposes the functionality of this API to the Azure cloud interfaces via an included Device Digitial Twin Model.  Information on the available functionality on the R700 as exposed by the Reader Configuration REST API can be found here: [Impinj Reader Configuration REST API](https://platform.impinj.com/site/docs/reader_api/index.gsp)

---
## **Purpose**

The Purpose of the Impinj Reader R700 adapter is to connect the reader to Azure cloud services, and to expose the functionality of the Reader Configuration REST API (& R700) to  Azure platform capibilities.

These open-source files are provided so that users may modify and extend the adapter to meet the needs of their application.  If you're only looking to use (not modify the latest standard version of the adapter, find the download link at the beginning of this document.

---
## **File Structure**

- `impinj_reader_r700`: top level adapter folder.  Contains main adapter code and header files, CMakeLists.txt, and this README.md
  - `cap`: contains the files necessary to build the CAP .upgx upgrade file
    - `build`: generated by the build script `build-r700.sh`, and will contain the .upgx CAP file after build is complete
  - `curl_wrapper`: contains the wrapper files for the libcurl interface which interacts directly with the Reader Configuration REST API
  - `helpers`: contains a number of extra 'helper' function files and header files used in the adapter
  - `support_files`: contains non-code files required for building or using the adapter.  Look here for `ETKpath.txt` (requires update for build) and `config.json` (must be updated to connect the bridge to Azure & reader).
    - `device_model`: contains DTDL files which define the device model for the Impinj R700 Fixed Reader.
---
## **Usage**

### **Setup Source Code {#setup-source}**

For all build targets, first you will need to go through the setup steps outlined in the PnP Bridge general documentation to clone the PnP Bridge repository and all submodules into the proper locations.  See those instructions here: [Build and run the bridge on an IoT device or gateway](https://docs.microsoft.com/en-us/azure/iot-pnp/howto-build-deploy-extend-pnp-bridge#build-and-run-the-bridge-on-an-iot-device-or-gateway)

### **Build Binaries**

This PnP Bridge and corresponding R700 adapter can be compiled to run on the R700 reader itself, or on an external machine that communicates with the R700 over a local network.  In either case, R700 Adapter for the PnP Bridge uses the Reader Configuration REST API to interface with the reader.

**All instructions in this section assume a Linux/x86 build machine.**

- Compile to run on Linux/x86
  - Build Setup: same as outlined in [Setup Source Code](#setup-source) 
  - Run Build Script: `pnpbridge/scripts/linux/build.sh`
  - Build Outputs 
      - `pnpbridge/cmake/` (build artifacts folder)
      - Console Example: `pnpbridge/cmake/pnpbridge_linux/src/pnpbridge/samples/console/pnpbridge_bin`
- Cross-Compile to run on R700 (ARM)
  - Build Setup 
    1. Begin as outlined in [Setup Source Code](#setup-source).
    2. Download Impinj R700 Embedded Development Tools (Impinj R700 ETK) from: [Impinj R700 Reader Documents & Downloads](https://support.impinj.com/hc/en-us/articles/360011676720-Impinj-R700-Reader-Documents-Downloads)
        - Be sure to download the Embedded Development Tools version to match the R700 reader firmware version you are using.
    3. Install Impinj R700 Embedded Development Tools to build machine and note absolute path of installed files. 
       - Install means copy ETK ZIP file to destination folder on build machine, and unzip with: >`tar zxfv <filename>`
    4. Update `pnpbridge/src/adapters/src/impinj_reader_r700/support_files/ETKpath.txt` to contain absolute path to unzipped R700 ETK folder.
        - Ex: `/home/kwenner/impinj/etk/r700/7.5.0_Octane_Embedded_Development_Tools`
   - Run Build Script: `pnpbridge/scripts/linux/targets/impinj/build-r700.sh`
      - `build-r700.sh` requires the use of the Impinj R700 ETK (see "Build Setup" above)
      - `build-r700.sh` invokes the same `build.sh` for Linux/x86 build, but specifies a cross-compilation toolchain file located at: `pnpbridge/src/adapters/src/impinj_reader_r700/support_files/toolchainfile.cmake`
      - `build-r700.sh` also invokes the creation of a CAP .upgx upgrade file to install the PnP Bridge onto an R700 and run the PnP bridge application on reader startup.
    - Build Outputs
      - `pnpbridge/cmake/` (build artifacts folder - same as Linux/x86 build)
      - CAP upgrade file: `pnpbridge/src/adapters/src/impinj_reader_r700/cap/build/azure_pnpbridge_impinj_r700.upgx`
        - This file includes `pnpbridge_bin` and the `config.json` found in the `impinj_reader_r700/support_files` folder, and a `start` script to run the PnP Bridge application on reader boot.

### **Run Binaries**

- In all cases, run the `pnpbridge_bin` build export to start the PnP Bridge console application.  This application looks for a `config.json` configuration file next to it on disk.  (See [Configuration](#configuration))

  - Linux/x86: run the `pnpbridge_bin` executable.  (See Build Outputs for location)
  - R700 (ARM): (two options, not steps)
    1. copy the `pnpbridge_bin` executable and `config.json` to the reader via FTP, and then run `pnpbridge_bin`. It is recommended to copy and run under the `/cust/` folder on the reader. 
    2. install the `azure_pnpbridge_impinj_r700.upgx` CAP upgrade file to the reader.  This .upgx file includes `pnpbridge_bin` and `config.json`, and will cause the PnP Bridge application to start automatically after the reader boots.

### **Configuration {#configuration}**

The PnP Bridge Application requires a config.json file to specify connection parameters to the Azure cloud and device connection/communication parameters.  More general PnP Bridge configuration information can be found here: [Configure a bridge](https://docs.microsoft.com/en-us/azure/iot-pnp/howto-build-deploy-extend-pnp-bridge#configure-a-bridge)

- Impinj R700 - To configure a connection between an Impinj R700 Reader and the Azure cloud services follow these steps:
    1. Configure the Impinj R700 reader to use the **Impinj IoT Device Interface**.  This is important as the Reader Configuration REST API (included in the Impinj IoT Device Interface) is used by the PnP Bridge adapter to control the reader operations.  
       - Instructions on how to enable the Impinj IoT Device Interface can be found here: [How to Configure the Impinj R700 RAIN RFID Reader for Inventory Operation Using Presets](https://support.impinj.com/hc/en-us/articles/360017114459-How-to-configure-the-Impinj-R700-RAIN-RFID-reader-for-Inventory-operation-using-presets)
    2. Update the `config.json` file next to `pnpbridge_bin` with the proper connection parameters.  The template `config.json` file can be found at `pnpbridge/src/adapters/src/impinj_reader_r700/support_files/config.json`
       - `config.json` contains several sections that are required in order to communicate with both the reader and the Azure cloud.
         - `"pnp_bridge_connection_parameters"` includes the connection parameters to the Azure cloud services.  This will vary depending on your setup of these services, but you will likely require the following:
           - `"symmetric_key"` should be the primary key for individual device access.  If you are authenticating through a Device Provisioning Service (DPS), check the individual enrollment lists.
           - `"group_symmetric_key"` should be the primary key for group enrollment access.  If you are authenticating through a Device Provisioning Service (DPS), check the group enrollment lists.
           - `"id_scope"` is a code corresponding to the DPS instance.  
           - `"device_id"` dictates the name/ID of the connecting device as shown in IoT hub. 
         - `"pnp_bridge_interface_components"` is where all of the specific device adapter information is contained for the PnP Bridge to communicate with the local device.  For the Impinj R700 use case, we will only include information for one adapter, the Impinj Reader R700 adapter.  The configuration file included at `pnpbridge/src/adapters/src/impinj_reader_r700/support_files/config.json` has the template setup, but you will need to specify parameters under `"pnp_bridge_adapter_config"`:
           - `"hostname"` is the hostname or IP address of the R700 on the local network.  If running the PnP Bridge application on the reader, this can be `localhost`.
           - `"username"` is used to access the R700 APIs.  By default this is "root".
           - `"password"` is used to access the R700 APIs.  By default this is "impinj".

---
## **Contributing** 
Pull requests are welcome. For major changes, please open an issue first to discuss what you would like to change.

## **License**
[MIT](https://choosealicense.com/licenses/mit/)
